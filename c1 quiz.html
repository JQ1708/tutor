<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGCSE Year 8 - Respiration Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8;
        }
        .screen {
            display: none;
        }
        .active-screen {
            display: block;
        }
        .card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .slide {
            display: none;
        }
        .active-slide {
            display: block;
        }
        .option-btn {
            transition: all 0.2s ease-in-out;
        }
        .option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .option-btn.correct {
            background-color: #22c55e !important;
            color: white !important;
            border-color: #16a34a !important;
        }
        .option-btn.incorrect {
            background-color: #ef4444 !important;
            color: white !important;
            border-color: #dc2626 !important;
        }
        .subtopic-btn.locked {
            filter: grayscale(1);
            cursor: not-allowed;
            opacity: 0.6;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">

        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen active-screen text-center p-8 card fade-in">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-600 mb-4">Respiration Adventure!</h1>
            <p class="text-lg text-gray-700 mb-8">Hello Candice! Get ready to explore the amazing world of respiration. Let's learn together and ace this topic!</p>
            <button id="start-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full text-xl transition duration-300 shadow-lg">Let's Begin!</button>
        </div>

        <!-- Subtopic Selection Screen -->
        <div id="subtopic-selection-screen" class="screen p-8 card fade-in">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Choose a Subtopic</h2>
            <div id="subtopic-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Subtopic buttons will be generated by JS -->
            </div>
        </div>

        <!-- Presentation Screen -->
        <div id="presentation-screen" class="screen p-6 md:p-8 card fade-in">
            <h2 id="presentation-title" class="text-2xl md:text-3xl font-bold text-center text-indigo-700 mb-6"></h2>
            <div id="slides-container" class="relative min-h-[350px] md:min-h-[400px] bg-indigo-50 p-6 rounded-xl">
                <!-- Slides will be injected here -->
            </div>
            <div class="flex justify-between items-center mt-6">
                <button id="prev-slide-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-full transition">Previous</button>
                <span id="slide-counter" class="text-gray-600 font-semibold"></span>
                <button id="next-slide-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-full transition">Next</button>
            </div>
            <button id="start-quiz-btn" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full w-full mt-6 text-lg">Start Quiz!</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen p-6 md:p-8 card fade-in">
            <div class="flex justify-between items-center mb-4">
                <div class="text-sm font-semibold">
                    <span>Score: </span><span id="score">0</span>
                    <span> | Wrong: </span><span id="wrong-count">0</span>
                </div>
                <div class="text-sm font-semibold">
                    <span>Question: </span><span id="question-number">1</span> / <span id="total-questions">30</span>
                </div>
            </div>
            <div id="progress-bar" class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                <div id="progress" class="bg-blue-600 h-2.5 rounded-full" style="width: 3.33%"></div>
            </div>
            <h3 id="question-text" class="text-xl md:text-2xl font-semibold text-gray-800 mb-6 min-h-[80px]"></h3>
            <div id="options-container" class="grid grid-cols-2 gap-4">
                <!-- Options will be injected here -->
            </div>
        </div>

        <!-- Correction Screen -->
        <div id="correction-screen" class="screen p-6 md:p-8 card fade-in">
            <h2 class="text-3xl font-bold text-center text-orange-500 mb-2">Correction Time!</h2>
            <p class="text-center text-gray-600 mb-6">Let's review the questions you missed. You must get them right to unlock the next level!</p>
            <div id="correction-question-container">
                 <h3 id="correction-question-text" class="text-xl md:text-2xl font-semibold text-gray-800 mb-6 min-h-[80px]"></h3>
                <div id="correction-options-container" class="grid grid-cols-2 gap-4">
                    <!-- Correction options will be injected here -->
                </div>
            </div>
        </div>
        
        <!-- Modal -->
        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div id="modal-content" class="bg-white rounded-2xl p-8 text-center shadow-2xl max-w-sm w-full fade-in">
                <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>
                <p id="modal-text" class="text-gray-700 mb-6"></p>
                <button id="modal-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-full">OK</button>
            </div>
        </div>

    </div>

    <script>
        // --- DOM Elements ---
        const screens = {
            welcome: document.getElementById('welcome-screen'),
            subtopicSelection: document.getElementById('subtopic-selection-screen'),
            presentation: document.getElementById('presentation-screen'),
            game: document.getElementById('game-screen'),
            correction: document.getElementById('correction-screen'),
        };
        const startBtn = document.getElementById('start-btn');
        const subtopicGrid = document.getElementById('subtopic-grid');
        const presentationTitle = document.getElementById('presentation-title');
        const slidesContainer = document.getElementById('slides-container');
        const prevSlideBtn = document.getElementById('prev-slide-btn');
        const nextSlideBtn = document.getElementById('next-slide-btn');
        const slideCounter = document.getElementById('slide-counter');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const scoreEl = document.getElementById('score');
        const wrongCountEl = document.getElementById('wrong-count');
        const questionNumberEl = document.getElementById('question-number');
        const totalQuestionsEl = document.getElementById('total-questions');
        const progress = document.getElementById('progress');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const correctionScreen = document.getElementById('correction-screen');
        const correctionQuestionText = document.getElementById('correction-question-text');
        const correctionOptionsContainer = document.getElementById('correction-options-container');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const modalBtn = document.getElementById('modal-btn');

        // --- Game State ---
        let state = {
            studentName: "Candice",
            currentScreen: 'welcome',
            unlockedSubtopics: 1,
            currentSubtopicIndex: -1,
            currentSlide: 0,
            score: 0,
            wrongCount: 0,
            currentQuestionIndex: 0,
            attempts: 0,
            incorrectlyAnswered: [],
            currentCorrectionIndex: 0,
            questionsForCurrentQuiz: [],
        };

        // --- Data: Subtopics, Slides, and Questions ---
        const data = [
            {
                title: "The Human Respiratory System",
                slides: [
                    { title: "Pathway of Air", content: `Air enters through the <strong>Nose or Mouth</strong>, travels down the <strong>Trachea</strong> (windpipe), splits into two <strong>Bronchi</strong> (one for each lung), which then branch into smaller <strong>Bronchioles</strong>, and finally reaches the tiny <strong>Air Sacs (Alveoli)</strong>.` },
                    { title: "Key Structures", content: `The <strong>Trachea</strong> is kept open by rings of cartilage. The <strong>Larynx</strong> (voicebox) contains vocal cords to produce sound. The lungs are protected by the <strong>Rib Cage</strong>.` },
                    { title: "The Lungs", content: `The main organs of the respiratory system. They are spongy, air-filled organs where gas exchange happens. They are separated by the heart and protected by the ribs.` }
                ],
                questions: [
                    { q: "What is another name for the 'windpipe'?", a: "Trachea", o: ["Bronchus", "Larynx", "Esophagus", "Alveoli", "Pharynx"] },
                    { q: "What structures prevent the trachea from collapsing?", a: "Rings of cartilage", o: ["Bones", "Muscles", "Vocal cords", "Tiny hairs", "Membranes"] },
                    { q: "After the trachea, air passes into two tubes called...", a: "Bronchi", o: ["Bronchioles", "Alveoli", "Arteries", "Larynxes", "Capillaries"] },
                    { q: "The bronchi branch into even smaller tubes known as...", a: "Bronchioles", o: ["Bronchi", "Tracheas", "Air Sacs", "Veins", "Nostrils"] },
                    { q: "Where does the exchange of gases primarily take place?", a: "Alveoli (Air Sacs)", o: ["Trachea", "Heart", "Bronchi", "Nose", "Diaphragm"] },
                    { q: "Which part of the respiratory system contains the vocal cords?", a: "Larynx", o: ["Trachea", "Pharynx", "Bronchus", "Mouth", "Ribs"] },
                    { q: "What is the large, dome-shaped muscle at the bottom of the chest cavity?", a: "Diaphragm", o: ["Intercostal muscle", "Pectoral muscle", "Stomach", "Heart", "Larynx"] },
                    { q: "Which of these is NOT part of the human respiratory system?", a: "Esophagus", o: ["Nose", "Trachea", "Lungs", "Bronchiole", "Diaphragm"] },
                    { q: "The tiny hairs that line the airways and help clean them are called...", a: "Cilia", o: ["Villi", "Flagella", "Cartilage", "Alveoli", "Capillaries"] },
                    { q: "How many main bronchi are there in the human respiratory system?", a: "Two", o: ["One", "Four", "Ten", "Hundreds", "Millions"] },
                    { q: "What is the primary function of the nose in the respiratory system?", a: "To warm, moisten, and filter air", o: ["To produce sound", "To exchange gases", "To direct food to the stomach", "To connect to the brain", "To cool the body"] },
                    { q: "The entire network of organs involved in breathing is known as the...", a: "Respiratory system", o: ["Circulatory system", "Digestive system", "Nervous system", "Skeletal system", "Muscular system"] },
                    { q: "What protects the lungs from physical damage?", a: "The rib cage", o: ["The diaphragm", "The heart", "The stomach", "The skin", "The cartilage"] },
                    { q: "The singular form of 'bronchi' is...", a: "Bronchus", o: ["Bronchiole", "Bronchitis", "Broncha", "Bronch", "Bronx"] },
                    { q: "Which structure is also known as the voicebox?", a: "Larynx", o: ["Pharynx", "Trachea", "Epiglottis", "Bronchus", "Alveolus"] },
                    { q: "The muscles located between the ribs are called...", a: "Intercostal muscles", o: ["Diaphragm", "Pectorals", "Biceps", "Abdominals", "Triceps"] },
                    { q: "What is the common passageway for both air and food?", a: "Pharynx", o: ["Larynx", "Trachea", "Esophagus", "Mouth", "Nose"] },
                    { q: "The trachea is located ____ to the esophagus.", a: "In front of (anterior)", o: ["Behind (posterior)", "Above", "Below", "To the side of", "Inside"] },
                    { q: "What is the main purpose of the mucus in the respiratory tract?", a: "To trap dust and pathogens", o: ["To help in gas exchange", "To produce sound", "To cool the air", "To dry the air", "To carry blood"] },
                    { q: "The exchange of air between the lungs and the atmosphere is called...", a: "Breathing (Ventilation)", o: ["Respiration", "Circulation", "Diffusion", "Osmosis", "Digestion"] },
                    { q: "What covers the larynx during swallowing to prevent food from entering the trachea?", a: "Epiglottis", o: ["Tongue", "Vocal cords", "Uvula", "Pharynx", "Cartilage"] },
                    { q: "Which lung is typically smaller to make room for the heart?", a: "The left lung", o: ["The right lung", "Both are the same size", "The top lung", "The bottom lung", "Neither"] },
                    { q: "The right lung is divided into how many lobes?", a: "Three", o: ["Two", "Four", "One", "Five", "Six"] },
                    { q: "The left lung is divided into how many lobes?", a: "Two", o: ["Three", "Four", "One", "Five", "Six"] },
                    { q: "The final, smallest branches of the bronchial tree are the...", a: "Bronchioles", o: ["Trachea", "Alveoli", "Bronchi", "Pharynx", "Larynx"] },
                    { q: "What is the pleural membrane?", a: "A double-layered sac surrounding the lungs", o: ["The wall of an air sac", "The muscle of the diaphragm", "The cartilage in the trachea", "The lining of the nose", "The vocal cord"] },
                    { q: "The function of the fluid in the pleural cavity is to...", a: "Reduce friction during breathing", o: ["Exchange gases", "Warm the air", "Trap dust", "Carry oxygen", "Produce sound"] },
                    { q: "The main purpose of the respiratory system is to supply the body with ____.", a: "Oxygen", o: ["Carbon dioxide", "Glucose", "Water", "Nitrogen", "Food"] },
                    { q: "And to remove ____ from the body.", a: "Carbon dioxide", o: ["Oxygen", "Glucose", "Water", "Nitrogen", "Energy"] },
                    { q: "Where does the trachea split into the two main bronchi?", a: "In the chest, behind the heart", o: ["In the throat", "At the top of the lungs", "Inside the diaphragm", "In the nose", "At the voicebox"] }
                ]
            },
            {
                title: "Gas Exchange",
                slides: [
                    { title: "What is Gas Exchange?", content: `This is the process where <strong>oxygen</strong> from the air you breathe in passes into your blood, and <strong>carbon dioxide</strong> from your body passes out of your blood into the air to be breathed out. This happens in the alveoli.` },
                    { title: "Features of Alveoli", content: `Alveoli are perfect for gas exchange because they have: <br>1. <strong>Thin walls</strong> (one cell thick). <br>2. A <strong>large surface area</strong> (millions of them!). <br>3. A <strong>good blood supply</strong> from a network of tiny capillaries.` },
                    { title: "Diffusion", content: `Gases move by a process called <strong>diffusion</strong>. They move from an area of high concentration to an area of low concentration. Oxygen is high in the alveoli and low in the blood, so it moves into the blood. Carbon dioxide is the opposite.` }
                ],
                questions: [
                    { q: "Gas exchange in the lungs happens in the...", a: "Alveoli", o: ["Bronchi", "Trachea", "Heart", "Diaphragm", "Ribs"] },
                    { q: "The process by which gases move across the alveoli walls is called...", a: "Diffusion", o: ["Respiration", "Breathing", "Osmosis", "Circulation", "Contraction"] },
                    { q: "Which gas moves from the alveoli into the blood?", a: "Oxygen", o: ["Carbon Dioxide", "Nitrogen", "Water Vapour", "Hydrogen", "Methane"] },
                    { q: "Which gas moves from the blood into the alveoli?", a: "Carbon Dioxide", o: ["Oxygen", "Nitrogen", "Air", "Helium", "Glucose"] },
                    { q: "Alveoli have very thin walls to...", a: "Allow for a short diffusion distance", o: ["Make them stronger", "Store more air", "Help you speak", "Warm the air", "Filter dust"] },
                    { q: "The large number of alveoli in the lungs provides a...", a: "Large surface area", o: ["Strong structure", "Small surface area", "Place for food storage", "Source of heat", "Way to make noise"] },
                    { q: "What surrounds the alveoli to pick up oxygen?", a: "Capillaries", o: ["Bronchioles", "Large arteries", "Bones", "Muscles", "Cartilage"] },
                    { q: "Inspired (breathed in) air has more ____ than expired (breathed out) air.", a: "Oxygen", o: ["Carbon Dioxide", "Water Vapour", "Heat", "Pollution", "Nitrogen"] },
                    { q: "What chemical is used to test for carbon dioxide?", a: "Limewater", o: ["Acid", "Water", "Iodine", "Ethanol", "Salt"] },
                    { q: "When testing for carbon dioxide, limewater turns...", a: "Cloudy/milky", o: ["Blue", "Red", "Clear", "Black", "Purple"] },
                    { q: "How thick are the walls of an alveolus and a capillary?", a: "One cell thick", o: ["Two cells thick", "Ten cells thick", "Very thick", "One millimeter thick", "One centimeter thick"] },
                    { q: "The total surface area of the alveoli is roughly the size of a...", a: "Tennis court", o: ["Ping pong table", "Football field", "Postage stamp", "Car", "Swimming pool"] },
                    { q: "Why is a good blood supply crucial for efficient gas exchange?", a: "To maintain a steep concentration gradient", o: ["To keep the lungs warm", "To make the walls stronger", "To provide energy", "To filter the blood", "To produce mucus"] },
                    { q: "The air you breathe out is called...", a: "Expired air", o: ["Inspired air", "Respired air", "Old air", "Bad air", "Used air"] },
                    { q: "Expired air contains more ____ than inspired air.", a: "Carbon dioxide and water vapour", o: ["Oxygen and nitrogen", "Only nitrogen", "Only oxygen", "Glucose", "Pollutants"] },
                    { q: "What happens to the oxygen once it enters the red blood cells?", a: "It binds with haemoglobin", o: ["It dissolves in the cytoplasm", "It is used for energy immediately", "It turns into carbon dioxide", "It is stored in the nucleus", "It is destroyed"] },
                    { q: "The movement of gas from high to low concentration is a ____ process.", a: "Passive", o: ["Active", "Energy-requiring", "Complex", "Slow", "Loud"] },
                    { q: "What feature of the alveoli helps oxygen dissolve before diffusing?", a: "A moist lining", o: ["Their thick walls", "The cartilage rings", "The presence of cilia", "Their dry surface", "Their high temperature"] },
                    { q: "The blood arriving at the lungs from the body is...", a: "Deoxygenated", o: ["Oxygenated", "Full of glucose", "Very hot", "Bright red", "Lacking plasma"] },
                    { q: "The blood leaving the lungs to go to the body is...", a: "Oxygenated", o: ["Deoxygenated", "Full of carbon dioxide", "Very cold", "Dark red", "Lacking red blood cells"] },
                    { q: "What is the approximate percentage of oxygen in inspired air?", a: "21%", o: ["78%", "16%", "4%", "0.04%", "100%"] },
                    { q: "What is the approximate percentage of oxygen in expired air?", a: "16%", o: ["21%", "78%", "4%", "0.04%", "0%"] },
                    { q: "What is the approximate percentage of carbon dioxide in inspired air?", a: "0.04%", o: ["4%", "16%", "21%", "78%", "1%"] },
                    { q: "What is the approximate percentage of carbon dioxide in expired air?", a: "4%", o: ["0.04%", "16%", "21%", "78%", "10%"] },
                    { q: "The concentration gradient for a gas refers to the...", a: "Difference in its concentration between two areas", o: ["Speed at which it moves", "Temperature of the gas", "Weight of the gas", "Color of the gas", "Amount of water in it"] },
                    { q: "Gas exchange is sometimes referred to as...", a: "External respiration", o: ["Internal respiration", "Breathing", "Cellular respiration", "Ventilation", "Circulation"] },
                    { q: "The efficiency of gas exchange is reduced if...", a: "The surface area of alveoli is damaged", o: ["You breathe faster", "Your heart beats faster", "You have more red blood cells", "The air is cold", "The air is warm"] },
                    { q: "Which gas has roughly the same percentage in both inspired and expired air?", a: "Nitrogen", o: ["Oxygen", "Carbon Dioxide", "Water Vapour", "Argon", "Helium"] },
                    { q: "The pressure of a specific gas in a mixture is called its...", a: "Partial pressure", o: ["Total pressure", "Atmospheric pressure", "Blood pressure", "Vapour pressure", "Absolute pressure"] },
                    { q: "Diffusion of gases occurs because particles are in...", a: "Constant, random motion", o: ["Fixed positions", "A straight line", "A liquid state", "A solid state", "A circular path"] }
                ]
            },
            {
                title: "The Mechanics of Breathing",
                slides: [
                    { title: "Breathing In (Inhalation)", content: `1. The <strong>intercostal muscles</strong> between the ribs contract, pulling the rib cage <strong>up and out</strong>. <br>2. The <strong>diaphragm</strong> muscle contracts and <strong>flattens</strong> (moves down). <br>3. This <strong>increases the volume</strong> inside the chest, which <strong>decreases the pressure</strong>, causing air to rush in.` },
                    { title: "Breathing Out (Exhalation)", content: `1. The <strong>intercostal muscles</strong> relax, letting the rib cage fall <strong>down and in</strong>. <br>2. The <strong>diaphragm</strong> muscle relaxes and returns to its <strong>domed shape</strong> (moves up). <br>3. This <strong>decreases the volume</strong> inside the chest, which <strong>increases the pressure</strong>, forcing air out.` }
                ],
                questions: [
                    { q: "When you breathe in, the intercostal muscles...", a: "Contract", o: ["Relax", "Expand", "Disappear", "Dissolve", "Vibrate"] },
                    { q: "During inhalation, the diaphragm...", a: "Contracts and flattens", o: ["Relaxes and becomes domed", "Stays still", "Moves to the side", "Vibrates", "Disappears"] },
                    { q: "When the volume of the chest increases, the pressure inside...", a: "Decreases", o: ["Increases", "Stays the same", "Becomes zero", "Doubles", "Triples"] },
                    { q: "What happens to the rib cage when you breathe in?", a: "Moves up and out", o: ["Moves down and in", "Stays still", "Moves sideways", "Flattens", "Shrinks"] },
                    { q: "When you breathe out, the intercostal muscles...", a: "Relax", o: ["Contract", "Get shorter", "Get stronger", "Push outwards", "Pull inwards"] },
                    { q: "During exhalation, the diaphragm...", a: "Relaxes and becomes domed", o: ["Contracts and flattens", "Moves down", "Pushes on the heart", "Stops moving", "Gets smaller"] },
                    { q: "Breathing out is also known as...", a: "Exhalation", o: ["Inhalation", "Respiration", "Diffusion", "Circulation", "Perspiration"] },
                    { q: "The movement of the ribs and diaphragm changes the ____ inside the chest.", a: "Volume and pressure", o: ["Temperature", "Colour", "Weight", "Gases", "Smell"] },
                    { q: "Which of these is a passive process, usually not requiring muscle contraction?", a: "Normal exhalation", o: ["Inhalation", "Deep inhalation", "Forced exhalation", "Coughing", "Sneezing"] },
                    { q: "Breathing in is also known as...", a: "Inhalation", o: ["Exhalation", "Expiration", "Respiration", "Perspiration", "Circulation"] },
                    { q: "Air moves into the lungs because the pressure inside is ____ than outside.", a: "Lower", o: ["Higher", "The same", "Warmer", "Colder", "Wetter"] },
                    { q: "Air moves out of the lungs because the pressure inside is ____ than outside.", a: "Higher", o: ["Lower", "The same", "Warmer", "Colder", "Drier"] },
                    { q: "Forced exhalation (e.g., blowing out a candle) involves the contraction of which muscles?", a: "Abdominal muscles", o: ["Neck muscles", "Leg muscles", "Arm muscles", "Back muscles", "Jaw muscles"] },
                    { q: "The volume of air breathed in and out during normal, quiet breathing is called the...", a: "Tidal volume", o: ["Vital capacity", "Total lung capacity", "Residual volume", "Expired volume", "Inspired volume"] },
                    { q: "What happens to your breathing rate when you exercise?", a: "It increases", o: ["It decreases", "It stays the same", "It stops", "It becomes irregular", "It becomes shallower"] },
                    { q: "The maximum volume of air you can breathe out after a deep breath in is your...", a: "Vital capacity", o: ["Tidal volume", "Residual volume", "Total capacity", "Forced capacity", "Lung volume"] },
                    { q: "The action of the diaphragm contracting and moving down leads to...", a: "Inhalation", o: ["Exhalation", "A cough", "A sneeze", "Hiccups", "Yawning"] },
                    { q: "The action of the rib cage moving down and in leads to...", a: "Exhalation", o: ["Inhalation", "A deep breath", "A yawn", "Hiccups", "Speaking"] },
                    { q: "Breathing is controlled by which part of the brain?", a: "The brainstem (medulla)", o: ["The cerebrum", "The cerebellum", "The frontal lobe", "The cortex", "The spinal cord"] },
                    { q: "What is another term for the chest cavity?", a: "Thoracic cavity", o: ["Abdominal cavity", "Cranial cavity", "Pelvic cavity", "Spinal cavity", "Body cavity"] },
                    { q: "A hiccup is caused by a sudden, involuntary contraction of the...", a: "Diaphragm", o: ["Intercostal muscles", "Lungs", "Stomach", "Heart", "Trachea"] },
                    { q: "When you hold your breath, what builds up in your blood that forces you to breathe?", a: "Carbon dioxide", o: ["Oxygen", "Nitrogen", "Lactic acid", "Water", "Glucose"] },
                    { q: "The lungs themselves do not contain any...", a: "Muscle tissue for contraction", o: ["Blood vessels", "Air sacs", "Nerves", "Elastic tissue", "Bronchioles"] },
                    { q: "The natural tendency of the lungs is to...", a: "Recoil and collapse", o: ["Expand", "Stay the same size", "Fill with fluid", "Move up", "Move down"] },
                    { q: "What keeps the lungs from collapsing completely?", a: "The pleural fluid and chest wall", o: ["Cartilage rings", "The diaphragm", "The heart", "Strong muscles", "Air pressure"] },
                    { q: "When the diaphragm relaxes, it moves...", a: "Upwards", o: ["Downwards", "Sideways", "Forwards", "Backwards", "It stops"] },
                    { q: "When the intercostal muscles contract, they pull the ribs...", a: "Up and out", o: ["Down and in", "Closer together", "Further apart", "Sideways", "Backwards"] },
                    { q: "The overall process of moving air in and out is called...", a: "Ventilation", o: ["Respiration", "Circulation", "Diffusion", "Perspiration", "Digestion"] },
                    { q: "Do the intercostal muscles and diaphragm contract at the same time during inhalation?", a: "Yes", o: ["No, diaphragm is first", "No, ribs are first", "Only the diaphragm contracts", "Only the ribs contract", "They alternate"] },
                    { q: "The pressure changes in the thoracic cavity are best explained by...", a: "Boyle's Law", o: ["Newton's Laws", "Charles's Law", "The Law of Gravity", "Ohm's Law", "The Theory of Relativity"] }
                ]
            },
            {
                title: "Cellular Respiration",
                slides: [
                    { title: "What is Respiration?", content: `Respiration is a <strong>chemical reaction</strong> that happens inside <strong>every living cell</strong> (not just in the lungs!). Its purpose is to release <strong>energy</strong> from food (glucose).` },
                    { title: "Aerobic Respiration", content: `This is the most common type of respiration in humans. It requires <strong>oxygen</strong>. It happens in tiny structures inside the cell called <strong>mitochondria</strong>.` },
                    { title: "The Word Equation", content: `<div class="text-center p-4 bg-green-100 rounded-lg"><strong>Glucose + Oxygen → Carbon Dioxide + Water (+ Energy)</strong></div>` }
                ],
                questions: [
                    { q: "What is the primary purpose of cellular respiration?", a: "To release energy", o: ["To breathe", "To get oxygen", "To make water", "To remove carbon dioxide", "To digest food"] },
                    { q: "Where in the cell does aerobic respiration occur?", a: "Mitochondria", o: ["Nucleus", "Cell membrane", "Cytoplasm", "Ribosome", "Vacuole"] },
                    { q: "What is the 'fuel' for aerobic respiration?", a: "Glucose", o: ["Oxygen", "Water", "Carbon Dioxide", "Sunlight", "Nitrogen"] },
                    { q: "Which gas is required for aerobic respiration?", a: "Oxygen", o: ["Carbon Dioxide", "Nitrogen", "Hydrogen", "Methane", "Water Vapour"] },
                    { q: "What are the two products of aerobic respiration (besides energy)?", a: "Carbon Dioxide and Water", o: ["Glucose and Oxygen", "Oxygen and Water", "Glucose and Carbon Dioxide", "Oxygen and Lactic Acid", "Water and Glucose"] },
                    { q: "What is the key difference between breathing and respiration?", a: "Breathing is physical, respiration is chemical", o: ["They are the same thing", "Breathing happens in cells, respiration in lungs", "Respiration uses muscles", "Breathing releases energy", "Only animals breathe"] },
                    { q: "The word 'aerobic' means...", a: "With oxygen", o: ["Without oxygen", "In the air", "In water", "With energy", "Without energy"] },
                    { q: "Which of the following completes the equation: Glucose + Oxygen -> ?", a: "Carbon Dioxide + Water", o: ["Lactic Acid", "Oxygen + Water", "Glucose", "Breathing", "Air"] },
                    { q: "Do plant cells respire?", a: "Yes, all the time", o: ["No, they photosynthesise", "Only at night", "Only in the day", "Only in their roots", "Only in their leaves"] },
                    { q: "Energy released from respiration is used for...", a: "All of the below", o: ["Movement", "Keeping warm", "Growth and repair", "Sending nerve impulses", "Building large molecules"] },
                    { q: "Respiration is considered an ____ reaction because it releases energy.", a: "Exothermic", o: ["Endothermic", "Neutral", "Acidic", "Basic", "Physical"] },
                    { q: "Which are the reactants in the aerobic respiration equation?", a: "Glucose and Oxygen", o: ["Carbon Dioxide and Water", "Energy and Water", "Oxygen and Carbon Dioxide", "Glucose and Water", "Energy and Glucose"] },
                    { q: "Which are the products in the aerobic respiration equation?", a: "Carbon Dioxide and Water", o: ["Glucose and Oxygen", "Energy and Oxygen", "Oxygen and Carbon Dioxide", "Glucose and Water", "Energy and Glucose"] },
                    { q: "What type of energy is stored in glucose?", a: "Chemical energy", o: ["Kinetic energy", "Heat energy", "Light energy", "Electrical energy", "Potential energy"] },
                    { q: "Which system is responsible for delivering glucose to the cells?", a: "Circulatory system", o: ["Respiratory system", "Digestive system", "Nervous system", "Skeletal system", "Excretory system"] },
                    { q: "The carbon dioxide produced during respiration is considered a...", a: "Waste product", o: ["Useful product", "Reactant", "Fuel", "Catalyst", "Enzyme"] },
                    { q: "Which cells in the body would have the most mitochondria?", a: "Muscle cells", o: ["Skin cells", "Fat cells", "Bone cells", "Red blood cells", "Nerve cells"] },
                    { q: "What happens to your respiration rate during vigorous exercise?", a: "It increases significantly", o: ["It decreases", "It stays the same", "It stops temporarily", "It becomes less efficient", "It produces less energy"] },
                    { q: "Respiration that occurs without oxygen is called...", a: "Anaerobic respiration", o: ["Aerobic respiration", "Breathing", "Photosynthesis", "Fermentation", "Oxidation"] },
                    { q: "In humans, anaerobic respiration in muscles produces...", a: "Lactic acid", o: ["Carbon dioxide and ethanol", "Water", "Glucose", "Oxygen", "Lots of energy"] },
                    { q: "The energy from respiration is stored in a molecule called...", a: "ATP (Adenosine Triphosphate)", o: ["DNA", "RNA", "Glucose", "Haemoglobin", "Enzyme"] },
                    { q: "How is the water produced during respiration removed from the body?", a: "Exhaled as water vapour and in urine", o: ["Only through sweat", "Only through tears", "It is stored in cells", "It is converted to oxygen", "It is used for digestion"] },
                    { q: "Compared to aerobic respiration, anaerobic respiration releases...", a: "Much less energy", o: ["Much more energy", "The same amount of energy", "No energy", "Only heat energy", "Only light energy"] },
                    { q: "What is the main reason we need to breathe?", a: "To supply oxygen for cellular respiration", o: ["To cool down the body", "To make our lungs bigger", "To be able to talk", "To remove water", "To get rid of nitrogen"] },
                    { q: "Does respiration happen in a seed before it germinates?", a: "Yes, but at a very slow rate", o: ["No, it only starts after germination", "No, seeds photosynthesise", "Yes, at a very fast rate", "Only if it is in the dark", "Only if it is in the light"] },
                    { q: "The process of breaking down glucose is a form of...", a: "Oxidation", o: ["Reduction", "Melting", "Freezing", "Evaporation", "Sublimation"] },
                    { q: "Which life process is powered by the energy from respiration?", a: "All life processes", o: ["Only movement", "Only growth", "Only thinking", "Only digestion", "Only breathing"] },
                    { q: "What is the relationship between photosynthesis and respiration in plants?", a: "They are opposite processes", o: ["They are the same process", "Photosynthesis powers respiration", "Respiration powers photosynthesis", "They only happen at the same time", "Plants do not respire"] },
                    { q: "The heat generated by respiration helps mammals to...", a: "Maintain a constant body temperature", o: ["Cool down", "Absorb sunlight", "Digest food", "See in the dark", "Fly"] },
                    { q: "If a cell is deprived of oxygen, can it still release some energy from glucose?", a: "Yes, through anaerobic respiration", o: ["No, oxygen is always required", "Yes, but only if it's a plant cell", "No, the cell dies instantly", "Yes, through photosynthesis", "No, it uses fat instead"] }
                ]
            },
            {
                title: "The Role of Blood",
                slides: [
                    { title: "Components of Blood", content: `Blood is made of four main parts: <strong>Red Blood Cells</strong>, <strong>White Blood Cells</strong>, <strong>Platelets</strong>, and <strong>Plasma</strong> (the liquid part).` },
                    { title: "Transporting Gases", content: `<strong>Red blood cells</strong> contain a special red protein called <strong>haemoglobin</strong>. Oxygen binds to haemoglobin in the lungs to be carried to the body cells. <strong>Carbon dioxide</strong> is mostly carried dissolved in the <strong>plasma</strong>.` },
                    { title: "White Blood Cells", content: `These are part of the immune system. They help to defend the body against harmful microorganisms called <strong>pathogens</strong> (like bacteria and viruses).` }
                ],
                questions: [
                    { q: "What is the name of the red pigment in red blood cells that carries oxygen?", a: "Haemoglobin", o: ["Chlorophyll", "Melanin", "Plasma", "Antibody", "Mitochondria"] },
                    { q: "What is the main function of red blood cells?", a: "Transport oxygen", o: ["Fight infection", "Clot blood", "Carry nutrients", "Remove heat", "Produce energy"] },
                    { q: "Which component of blood is mainly responsible for fighting infection?", a: "White blood cells", o: ["Red blood cells", "Plasma", "Platelets", "Haemoglobin", "Glucose"] },
                    { q: "What is the liquid part of the blood called?", a: "Plasma", o: ["Water", "Cytoplasm", "Haemoglobin", "Serum", "Lymph"] },
                    { q: "When oxygen combines with haemoglobin, it forms...", a: "Oxyhaemoglobin", o: ["Carbon dioxide", "Water", "Glucose", "An antibody", "A pathogen"] },
                    { q: "How is most carbon dioxide transported in the blood?", a: "Dissolved in plasma", o: ["By red blood cells", "By white blood cells", "By platelets", "As a solid", "Attached to oxygen"] },
                    { q: "A key feature of a mature red blood cell is that it lacks a...", a: "Nucleus", o: ["Cell membrane", "Cytoplasm", "Haemoglobin", "Red colour", "Round shape"] },
                    { q: "Harmful microorganisms that can cause disease are called...", a: "Pathogens", o: ["Antibodies", "White blood cells", "Platelets", "Haemoglobin", "Alveoli"] },
                    { q: "Which part of blood transports glucose, hormones, and waste products?", a: "Plasma", o: ["Red blood cells", "White blood cells", "Platelets", "Haemoglobin", "The nucleus"] },
                    { q: "The absence of a nucleus in red blood cells allows for...", a: "More room for haemoglobin", o: ["The cell to live longer", "The cell to fight infection", "The cell to change shape easily", "The cell to divide", "The cell to produce energy"] },
                    { q: "What is the function of platelets?", a: "To help blood clot", o: ["To carry oxygen", "To fight disease", "To transport water", "To produce energy", "To carry carbon dioxide"] },
                    { q: "What gives red blood cells their characteristic biconcave disc shape?", a: "The lack of a nucleus", o: ["The presence of haemoglobin", "The cell membrane", "The pressure in arteries", "The temperature of the body", "The type of plasma"] },
                    { q: "The process where a white blood cell engulfs a pathogen is called...", a: "Phagocytosis", o: ["Diffusion", "Osmosis", "Respiration", "Circulation", "Clotting"] },
                    { q: "Some white blood cells produce proteins that disable pathogens. These are called...", a: "Antibodies", o: ["Antigens", "Haemoglobin", "Hormones", "Enzymes", "Platelets"] },
                    { q: "Where are blood cells made?", a: "In the bone marrow", o: ["In the heart", "In the lungs", "In the liver", "In the spleen", "In the blood vessels"] },
                    { q: "Blood that is rich in oxygen is what color?", a: "Bright red", o: ["Dark red", "Blue", "Purple", "Clear", "Yellow"] },
                    { q: "Blood that is poor in oxygen is what color?", a: "Dark red", o: ["Bright red", "Blue", "Green", "White", "Black"] },
                    { q: "The advantage of the biconcave shape of red blood cells is that it...", a: "Increases the surface area to volume ratio", o: ["Makes the cell stronger", "Helps it carry more water", "Allows it to divide", "Helps it produce antibodies", "Stores more glucose"] },
                    { q: "Which component makes up the largest percentage of blood volume?", a: "Plasma (about 55%)", o: ["Red blood cells (about 45%)", "White blood cells (<1%)", "Platelets (<1%)", "Haemoglobin", "Water"] },
                    { q: "Why don't red blood cells have mitochondria?", a: "So they don't use up the oxygen they carry", o: ["They don't need energy", "There is no space for them", "Mitochondria are only in muscle cells", "They are not living cells", "They get energy from the sun"] },
                    { q: "Anemia is a condition characterized by a lack of...", a: "Healthy red blood cells or haemoglobin", o: ["White blood cells", "Plasma", "Platelets", "Water in the blood", "Antibodies"] },
                    { q: "The journey of oxygen starts in the lungs and ends in the...", a: "Body cells", o: ["Heart", "Brain", "Kidneys", "Liver", "Stomach"] },
                    { q: "The haemoglobin lets go of oxygen in areas where oxygen concentration is...", a: "Low", o: ["High", "The same as in the lungs", "Zero", "Very cold", "Very hot"] },
                    { q: "Which of these is NOT transported by blood plasma?", a: "Air bubbles", o: ["Glucose", "Carbon dioxide", "Hormones", "Urea", "Antibodies"] },
                    { q: "A blood clot is formed by a mesh of protein fibers and trapped...", a: "Platelets and red blood cells", o: ["White blood cells", "Only plasma", "Only antibodies", "Pathogens", "Glucose molecules"] },
                    { q: "Which type of blood cell can change its shape to squeeze out of capillaries?", a: "White blood cells", o: ["Red blood cells", "All blood cells", "Platelets", "Dead blood cells", "New blood cells"] },
                    { q: "The iron-containing part of haemoglobin is what actually binds to oxygen.", a: "True", o: ["False", "Only in animals", "Only in plants", "Only in water", "Only at night"] },
                    { q: "What happens to old red blood cells?", a: "They are broken down in the liver and spleen", o: ["They are excreted in urine", "They leave the body through the skin", "They turn into white blood cells", "They divide to make new cells", "They dissolve in the plasma"] },
                    { q: "How many oxygen molecules can one haemoglobin molecule carry?", a: "Four", o: ["One", "Two", "Eight", "Ten", "Sixteen"] },
                    { q: "The delivery of oxygen to tissues and removal of carbon dioxide is essential for...", a: "Aerobic respiration", o: ["Digestion", "Thinking", "Sleeping", "Anaerobic respiration", "Growth"] }
                ]
            }
        ];

        // --- Functions ---

        function switchScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active-screen'));
            if (screens[screenName]) {
                screens[screenName].classList.add('active-screen');
                state.currentScreen = screenName;
            }
        }

        function showModal(title, text, buttonText = "OK", onButtonClick = () => modal.classList.add('hidden')) {
            modalTitle.textContent = title;
            modalText.innerHTML = text;
            modalBtn.textContent = buttonText;
            modalBtn.onclick = onButtonClick;
            modal.classList.remove('hidden');
        }

        function shuffleArray(array) {
            const newArray = [...array]; // Create a copy to avoid modifying the original
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // --- Subtopic Selection Logic ---
        function renderSubtopicSelection() {
            subtopicGrid.innerHTML = '';
            data.forEach((subtopic, index) => {
                const isLocked = index + 1 > state.unlockedSubtopics;
                const button = document.createElement('button');
                button.className = `subtopic-btn text-left p-6 rounded-2xl shadow-md transition duration-300 hover:shadow-lg hover:-translate-y-1 ${isLocked ? 'locked bg-gray-200 text-gray-500' : 'bg-white'}`;
                button.dataset.index = index;
                button.innerHTML = `
                    <div class="flex items-center mb-2">
                        <span class="text-xl font-bold ${isLocked ? 'text-gray-500' : 'text-blue-600'} mr-3">${index + 1}</span>
                        <h3 class="text-lg font-semibold ${isLocked ? 'text-gray-600' : 'text-gray-800'}">${subtopic.title}</h3>
                    </div>
                    <p class="text-sm ${isLocked ? 'text-gray-500' : 'text-gray-600'}">${isLocked ? 'Complete the previous level to unlock!' : 'Ready to learn!'}</p>
                `;
                if (!isLocked) {
                    button.onclick = () => startPresentation(index);
                }
                subtopicGrid.appendChild(button);
            });
        }

        // --- Presentation Logic ---
        function startPresentation(subtopicIndex) {
            state.currentSubtopicIndex = subtopicIndex;
            state.currentSlide = 0;
            renderSlides();
            switchScreen('presentation');
        }

        function renderSlides() {
            const subtopic = data[state.currentSubtopicIndex];
            presentationTitle.textContent = subtopic.title;
            slidesContainer.innerHTML = '';
            subtopic.slides.forEach((slide, index) => {
                const slideDiv = document.createElement('div');
                slideDiv.className = `slide p-4 ${index === state.currentSlide ? 'active-slide fade-in' : ''}`;
                slideDiv.innerHTML = `
                    <h4 class="text-xl font-bold text-gray-800 mb-4">${slide.title}</h4>
                    <p class="text-gray-700 leading-relaxed">${slide.content}</p>
                `;
                slidesContainer.appendChild(slideDiv);
            });
            updateSlideControls();
        }

        function updateSlideControls() {
            const totalSlides = data[state.currentSubtopicIndex].slides.length;
            slideCounter.textContent = `Slide ${state.currentSlide + 1} of ${totalSlides}`;
            prevSlideBtn.disabled = state.currentSlide === 0;
            prevSlideBtn.classList.toggle('opacity-50', state.currentSlide === 0);
            
            if (state.currentSlide === totalSlides - 1) {
                nextSlideBtn.classList.add('hidden');
                startQuizBtn.classList.remove('hidden');
            } else {
                nextSlideBtn.classList.remove('hidden');
                startQuizBtn.classList.add('hidden');
            }
        }

        // --- Game Logic ---
        function startGame() {
            state.score = 0;
            state.wrongCount = 0;
            state.currentQuestionIndex = 0;
            state.incorrectlyAnswered = [];
            // Select 30 random questions for this round
            state.questionsForCurrentQuiz = shuffleArray(data[state.currentSubtopicIndex].questions).slice(0, 30);
            updateScoreboard();
            renderQuestion();
            switchScreen('game');
        }

        function updateScoreboard() {
            scoreEl.textContent = state.score;
            wrongCountEl.textContent = state.wrongCount;
        }

        function renderQuestion() {
            state.attempts = 0;
            const question = state.questionsForCurrentQuiz[state.currentQuestionIndex];
            
            questionNumberEl.textContent = state.currentQuestionIndex + 1;
            totalQuestionsEl.textContent = state.questionsForCurrentQuiz.length;
            progress.style.width = `${((state.currentQuestionIndex + 1) / state.questionsForCurrentQuiz.length) * 100}%`;

            questionText.textContent = question.q;
            optionsContainer.innerHTML = '';

            const options = shuffleArray([question.a, ...question.o]);
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-btn bg-white border-2 border-gray-200 p-4 rounded-xl text-left text-gray-700 font-semibold hover:bg-blue-50 hover:border-blue-300';
                button.textContent = option;
                button.onclick = () => checkAnswer(option, button);
                optionsContainer.appendChild(button);
            });
        }

        function checkAnswer(selectedOption, button) {
            const question = state.questionsForCurrentQuiz[state.currentQuestionIndex];
            state.attempts++;

            if (selectedOption === question.a) {
                state.score++;
                button.classList.add('correct');
                disableOptions();
                setTimeout(nextQuestion, 1000);
            } else {
                button.classList.add('incorrect');
                button.disabled = true;

                if (state.attempts >= 2) {
                    state.wrongCount++;
                    state.incorrectlyAnswered.push(state.questionsForCurrentQuiz[state.currentQuestionIndex]);
                    disableOptions();
                    showModal("Let's move on!", `That was a tricky one, ${state.studentName}. We'll review it later.`, "Continue", () => {
                        modal.classList.add('hidden');
                        nextQuestion();
                    });
                } else {
                    showModal("Not quite!", `Give it one more try, ${state.studentName}!`, "Try Again", () => modal.classList.add('hidden'));
                }
            }
            updateScoreboard();
        }

        function disableOptions() {
            Array.from(optionsContainer.children).forEach(btn => btn.disabled = true);
        }

        function nextQuestion() {
            if (state.currentQuestionIndex < state.questionsForCurrentQuiz.length - 1) {
                state.currentQuestionIndex++;
                renderQuestion();
            } else {
                endSubtopicQuiz();
            }
        }

        function endSubtopicQuiz() {
            if (state.incorrectlyAnswered.length > 0) {
                startCorrection();
            } else {
                state.unlockedSubtopics = Math.max(state.unlockedSubtopics, state.currentSubtopicIndex + 2);
                showModal("Level Complete!", `Fantastic work, ${state.studentName}! You got everything right! You've unlocked the next subtopic.`, "Awesome!", () => {
                    modal.classList.add('hidden');
                    renderSubtopicSelection();
                    switchScreen('subtopicSelection');
                });
            }
        }

        // --- Correction Logic ---
        function startCorrection() {
            state.currentCorrectionIndex = 0;
            renderCorrectionQuestion();
            switchScreen('correction');
        }

        function renderCorrectionQuestion() {
            const question = state.incorrectlyAnswered[state.currentCorrectionIndex];

            correctionQuestionText.textContent = question.q;
            correctionOptionsContainer.innerHTML = '';
            
            const options = shuffleArray([question.a, ...question.o]);
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-btn bg-white border-2 border-gray-200 p-4 rounded-xl text-left text-gray-700 font-semibold hover:bg-orange-50 hover:border-orange-300';
                button.textContent = option;
                button.onclick = () => checkCorrectionAnswer(option, button);
                correctionOptionsContainer.appendChild(button);
            });
        }
        
        function checkCorrectionAnswer(selectedOption, button) {
            const question = state.incorrectlyAnswered[state.currentCorrectionIndex];

            if (selectedOption === question.a) {
                button.classList.add('correct');
                Array.from(correctionOptionsContainer.children).forEach(btn => btn.disabled = true);
                setTimeout(nextCorrectionQuestion, 1000);
            } else {
                button.classList.add('incorrect');
                button.disabled = true;
                showModal("Try Again!", "Think carefully, you need to find the correct answer to proceed.", "OK", () => modal.classList.add('hidden'));
            }
        }

        function nextCorrectionQuestion() {
            if (state.currentCorrectionIndex < state.incorrectlyAnswered.length - 1) {
                state.currentCorrectionIndex++;
                renderCorrectionQuestion();
            } else {
                state.unlockedSubtopics = Math.max(state.unlockedSubtopics, state.currentSubtopicIndex + 2);
                 showModal("Corrections Complete!", `Great job, ${state.studentName}! You've fixed all your mistakes and unlocked the next level.`, "Let's Go!", () => {
                    modal.classList.add('hidden');
                    renderSubtopicSelection();
                    switchScreen('subtopicSelection');
                });
            }
        }

        // --- Event Listeners ---
        startBtn.addEventListener('click', () => {
            renderSubtopicSelection();
            switchScreen('subtopicSelection');
        });

        prevSlideBtn.addEventListener('click', () => {
            if (state.currentSlide > 0) {
                state.currentSlide--;
                renderSlides();
            }
        });

        nextSlideBtn.addEventListener('click', () => {
            const totalSlides = data[state.currentSubtopicIndex].slides.length;
            if (state.currentSlide < totalSlides - 1) {
                state.currentSlide++;
                renderSlides();
            }
        });
        
        startQuizBtn.addEventListener('click', startGame);

    </script>
</body>
</html>

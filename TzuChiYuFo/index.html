<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- å…³é”®ï¼šç¡®ä¿æ‰‹æœºå±å¹•æ¯”ä¾‹æ­£ç¡® -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ…ˆæ¿Ÿ60å‘¨å¹´ - è¬äººæµ´ä½›èšç¦ç·£</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --tzuchi-gold: #fbbf24;
            --tzuchi-cream: #fef3c7;
            --deep-slate-start: #1e293b; 
            --deep-slate-end: #020617;   
            --modal-bg: #0f172a;         
        }

        body {
            font-family: 'Noto Serif TC', serif;
            background: radial-gradient(circle at top, var(--deep-slate-start), var(--deep-slate-end));
            background-color: var(--deep-slate-end);
            color: var(--tzuchi-cream);
            overflow-x: hidden; 
            margin: 0;
            padding: 0;
            /* æ‰‹æœºé«˜åº¦é€‚é…ä¼˜åŒ– */
            min-height: 100vh;
            min-height: 100dvh; 
        }

        .no-scroll { overflow: hidden; height: 100vh; height: 100dvh; }

        /* --- å±‚çº§ä¸åŠ¨æ•ˆ --- */
        #intro-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 3000;
            background-color: var(--deep-slate-end); 
            display: flex; justify-content: center; align-items: center;
            transition: opacity 3.0s ease-in-out; /* 3ç§’æŸ”å’Œæ·¡å‡º */
        }
        #lang-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000;
            background-color: rgba(2, 6, 23, 0.98); 
            display: none; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 1.5s ease;
        }
        #main-content {
            position: relative; z-index: 10; width: 100%; opacity: 0; transition: opacity 1.5s ease;
        }

        /* --- è§†é¢‘å®¹å™¨ (16:9) --- */
        .video-container {
            width: 100%; max-width: 900px; aspect-ratio: 16/9;
            background: #000; border-radius: 12px; overflow: hidden;
            position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            margin-bottom: 3rem;
        }

        /* --- æŒ‰é’®ç¾åŒ– --- */
        .btn-gold {
            border: 1px solid var(--tzuchi-gold); color: var(--tzuchi-gold);
            padding: 12px 40px; font-size: 1.1rem; border-radius: 50px;
            transition: all 0.3s; cursor: pointer; background: rgba(0,0,0,0.3); margin: 10px;
            /* æ‰‹æœºç‚¹å‡»åŒºåŸŸä¼˜åŒ– */
            min-width: 140px; text-align: center;
        }
        .btn-gold:active, .btn-gold:hover { background: var(--tzuchi-gold); color: #000; transform: scale(1.05); }

        /* --- æ‰‹åŠ¨ä¸Šä¼ è¦†ç›–å±‚ (ä¼˜é›…ç‰ˆ) --- */
        .manual-upload-overlay {
            position: absolute; inset: 0;
            background: rgba(15, 23, 42, 0.9); /* æ·±è“èƒŒæ™¯ */
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 20; padding: 20px; text-align: center;
        }
        .btn-upload {
            position: relative; overflow: hidden;
            background: linear-gradient(to right, #b45309, #d97706); /* æ…ˆæµé‡‘æ¸å˜ */
            color: white; border: none;
            padding: 12px 24px; border-radius: 8px;
            font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        .btn-upload input[type=file] {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }

        /* --- ç‚¹é˜µç‰¹æ•ˆ --- */
        .dot { fill: #475569; opacity: 0.3; transition: all 2.0s ease; }
        .dot.active { fill: var(--tzuchi-gold); opacity: 1; filter: drop-shadow(0 0 3px var(--tzuchi-gold)); }
        .flash-mode .dot {
            fill: #fbbf24 !important; opacity: 0.8 !important; r: 2.5 !important;
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.5)) !important;
            transition: all 1.5s ease-in-out !important;
        }
        .flash-mode .dot.active { fill: #fff !important; r: 4.0 !important; z-index: 100; }

        /* --- è¡¨å•å…ƒç´ ä¼˜åŒ– --- */
        select, input {
            -webkit-appearance: none; appearance: none;
            background-color: rgba(255,255,255,0.1); color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23fbbf24' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 1rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
        }
        .input-focus-effect:focus {
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);
            border-color: var(--tzuchi-gold);
        }
        
        /* Dropdown åˆ†ç»„æ ·å¼ */
        optgroup { color: #fbbf24; background: #1e293b; font-weight: bold; font-style: normal; }
        option { color: white; background: #0f172a; padding: 10px; }
    </style>

    <!-- é¢„åŠ è½½è„šæœ¬ (å¤´éƒ¨) -->
    <script>
        // é€šç”¨æ–‡ä»¶åŠ è½½å™¨
        function loadFile(input, type, callback) {
            const file = input.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            if (type === 'image') {
                const reader = new FileReader();
                reader.onload = (e) => callback(e.target.result);
                reader.readAsDataURL(file);
            } else if (type === 'video') {
                callback(url);
            }
            input.closest('.manual-upload-overlay').style.display = 'none';
        }
        // æ˜¾ç¤ºä¸Šä¼ æŒ‰é’® (å‡ºé”™æ—¶è°ƒç”¨)
        function showUploadUi(id) {
            const el = document.getElementById(id);
            if(el) el.style.display = 'flex';
        }
    </script>
</head>
<body class="no-scroll">

    <!-- LAYER 1: å¼€åœºä½›åƒ -->
    <div id="intro-layer">
        <div class="relative w-full h-full flex justify-center items-center p-4">
            <!-- ä½›åƒ -->
            <img id="buddha-img" src="Buddha.jpeg" class="max-w-full max-h-[80vh] object-contain drop-shadow-2xl" 
                 onerror="showUploadUi('buddha-upload')">
            
            <!-- å¤‡ç”¨ä¸Šä¼ æŒ‰é’® -->
            <div id="buddha-upload" class="manual-upload-overlay" style="display:none;">
                <p class="text-white mb-4 text-lg">ç„¡æ³•è®€å– Buddha.jpeg</p>
                <div class="btn-upload">
                    <span>ğŸ“‚ é¸æ“‡ä½›åƒç…§ç‰‡</span>
                    <input type="file" accept="image/*" onchange="loadFile(this, 'image', (src) => { 
                        document.getElementById('buddha-img').src = src; 
                        startIntro(); 
                    })">
                </div>
            </div>
        </div>
    </div>

    <!-- LAYER 2: è¯­è¨€é€‰æ‹© -->
    <div id="lang-layer">
        <div class="text-center mb-10">
            <h2 class="text-3xl text-yellow-400 mb-2 tracking-widest font-light">æ…ˆæ¿Ÿæµ´ä½›</h2>
            <p class="text-gray-400 text-sm tracking-wide">Tzu Chi Buddha Day</p>
        </div>
        <div class="flex flex-col gap-4 w-full max-w-xs px-8">
            <button class="btn-gold" onclick="selectLang('zh')">ä¸­æ–‡ (Chinese)</button>
            <button class="btn-gold" onclick="selectLang('en')">English (è‹±æ–‡)</button>
        </div>
    </div>

    <!-- LAYER 3: ä¸»ç•Œé¢ -->
    <div id="main-content" class="hidden">
        
        <!-- é¡¶éƒ¨æ•°æ®æ  -->
        <div class="fixed top-0 left-0 w-full z-20 flex justify-between items-start p-4 pointer-events-none">
            <div class="bg-slate-900/80 backdrop-blur-md p-3 rounded-xl border-l-4 border-yellow-500 shadow-lg">
                <div class="text-gray-400 text-[10px] uppercase tracking-wider lang-text" data-zh="å·²é»ç‡ˆ" data-en="Lit">å·²é»ç‡ˆ</div>
                <div class="text-xl font-bold text-white leading-none mt-1" id="count-display">0</div>
            </div>
            <div class="bg-slate-900/80 backdrop-blur-md p-3 rounded-xl border-r-4 border-gray-500 shadow-lg text-right">
                <div class="text-gray-400 text-[10px] uppercase tracking-wider lang-text" data-zh="å‰©é¤˜" data-en="Left">å‰©é¤˜</div>
                <div class="text-xl font-bold text-gray-300 leading-none mt-1" id="remaining-display">6000</div>
            </div>
        </div>

        <div class="flex flex-col items-center pt-28 pb-24 px-4 w-full max-w-4xl mx-auto">
            
            <h1 class="text-3xl md:text-5xl font-bold text-yellow-500 mb-8 tracking-[0.2em] text-center lang-text" data-zh="æ…ˆæ¿Ÿæµ´ä½›" data-en="Tzu Chi Buddha Day">æ…ˆæ¿Ÿæµ´ä½›</h1>

            <!-- è§†é¢‘æ’­æ”¾åŒº -->
            <div class="video-container">
                <video id="main-video" class="w-full h-full object-contain" controls playsinline webkit-playsinline>
                    <source src="Video.mp4" type="video/mp4">
                </video>
                
                <!-- æ‰‹åŠ¨é€‰æ‹©è§†é¢‘è¦†ç›–å±‚ -->
                <div id="video-upload" class="manual-upload-overlay">
                    <p class="text-white mb-6 text-lg lang-text" data-zh="è«‹è¼‰å…¥æ´»å‹•å½±ç‰‡" data-en="Load Video">è«‹è¼‰å…¥æ´»å‹•å½±ç‰‡</p>
                    <div class="btn-upload">
                        <span class="text-lg lang-text" data-zh="â–¶ï¸ é»æ“Šé¸æ“‡ Video.mp4" data-en="Select Video">â–¶ï¸ é»æ“Šé¸æ“‡ Video.mp4</span>
                        <input type="file" accept="video/*" onchange="loadFile(this, 'video', (url) => {
                            const v = document.getElementById('main-video');
                            v.src = url;
                            v.play().catch(e => console.log('Autoplay blocked', e));
                        })">
                    </div>
                </div>
            </div>

            <!-- SVG å›¾è…¾åŒº -->
            <div class="w-full relative mb-12" style="min-height: 300px; background: rgba(255,255,255,0.03); border-radius: 12px; overflow: hidden;">
                <div id="shape-loading" class="absolute inset-0 flex flex-col justify-center items-center pointer-events-none">
                    <svg class="animate-spin h-8 w-8 text-yellow-500 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="text-yellow-500 text-sm font-bold tracking-widest animate-pulse">LOADING...</span>
                </div>
                
                <div id="shape-upload" class="manual-upload-overlay" style="display:none;">
                    <p class="text-white mb-4">ç„¡æ³•è®€å– Shape.jpeg</p>
                    <div class="btn-upload">
                        <span>ğŸ“‚ é¸æ“‡ Shape.jpeg</span>
                        <input type="file" accept="image/*" onchange="loadFile(this, 'image', processShapeImage)">
                    </div>
                </div>
                
                <svg id="svg-stage" viewBox="0 0 1000 400" preserveAspectRatio="xMidYMid meet" class="w-full h-auto opacity-0 transition-opacity duration-1000"></svg>
            </div>

            <!-- æŠ¥åè¡¨æ ¼ -->
            <div class="w-full max-w-md bg-slate-800/50 p-6 rounded-2xl border border-white/10 backdrop-blur-md shadow-xl">
                <h2 class="text-xl text-center text-yellow-500 mb-6 font-light tracking-widest lang-text" data-zh="é»äº®å¿ƒç‡ˆ Â· å…±èšå–„å¿µ" data-en="Light a Lamp Â· Gather Love">é»äº®å¿ƒç‡ˆ Â· å…±èšå–„å¿µ</h2>
                <form id="prayer-form" class="space-y-5">
                    <div>
                        <input type="text" id="name" required class="w-full p-4 rounded-xl bg-black/20 text-white text-center outline-none focus:border-yellow-500 transition input-focus-effect placeholder-gray-500" placeholder="æ‚¨çš„å§“å">
                    </div>
                    <div>
                        <input type="tel" id="phone" required class="w-full p-4 rounded-xl bg-black/20 text-white text-center outline-none focus:border-yellow-500 transition input-focus-effect placeholder-gray-500" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼">
                    </div>
                    
                    <div class="relative">
                        <select id="area" required class="w-full p-4 rounded-xl bg-black/20 text-white text-center outline-none focus:border-yellow-500 transition cursor-pointer input-focus-effect">
                            <option value="" disabled selected class="text-gray-500 lang-text" data-zh="è«‹é¸æ“‡å€åŸŸ (å’Œæ°£/äº’æ„›)" data-en="Select Area">è«‹é¸æ“‡å€åŸŸ (å’Œæ°£/äº’æ„›)</option>
                            <!-- é€‰é¡¹ç”± JS åŠ¨æ€ç”Ÿæˆ -->
                        </select>
                    </div>

                    <button type="submit" class="w-full py-4 rounded-xl bg-gradient-to-r from-yellow-600 to-yellow-500 text-black font-bold text-lg shadow-[0_0_20px_rgba(234,179,8,0.3)] hover:shadow-yellow-500/50 hover:scale-[0.98] transition transform active:scale-95">
                        <span class="lang-text" data-zh="å‘ˆäº¤ç¥ˆé¡˜" data-en="Submit Prayer">å‘ˆäº¤ç¥ˆé¡˜</span>
                    </button>
                </form>
            </div>

        </div>
    </div>

    <!-- å¼¹çª— (å…¨å±é®ç½©) -->
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 hidden opacity-0 transition-opacity duration-500 p-4">
        <div class="bg-slate-900 border-2 border-yellow-500 p-8 rounded-2xl text-center max-w-sm w-full transform scale-90 transition-transform duration-300 shadow-2xl" id="modal-box">
            <div class="text-6xl mb-6">ğŸ™</div>
            <h3 class="text-xl text-yellow-400 font-bold mb-8 leading-relaxed lang-text" 
                data-zh="æ„Ÿæ©å ±åï¼Œ<br>æˆ‘å€‘æœƒå„˜å¿«èˆ‡æ‚¨è¯ç¹«" 
                data-en="Thank you.<br>We will contact you soon.">
                æ„Ÿæ©å ±åï¼Œ<br>æˆ‘å€‘æœƒå„˜å¿«èˆ‡æ‚¨è¯ç¹«
            </h3>
            <button onclick="closeModal()" class="w-full border border-yellow-500 text-yellow-500 px-6 py-3 rounded-xl hover:bg-yellow-500 hover:text-black transition font-bold tracking-widest">é—œé–‰</button>
        </div>
    </div>

    <!-- éšè—ç”»å¸ƒ -->
    <canvas id="analysis-canvas" style="display: none;"></canvas>

    <!-- ä¸»é€»è¾‘è„šæœ¬ -->
    <script>
        // ==========================================
        // åŒºåŸŸæ•°æ®é…ç½® (å·²æ•´ç†æ›´æ–°)
        // ==========================================
        const AREA_DATA = [
            { zone: "æ±1", areas: ["åŠ å½±", "åŒæºªé¾™é•‡"] },
            { zone: "æ±2", areas: ["å¤§åŒ", "å¤ªå­å›­", "å®‰é‚¦"] },
            { zone: "ä¸­1", areas: ["å¤§åŸå ¡", "æ—§å§ç”Ÿè·¯"] },
            { zone: "ä¸­2", areas: ["æ²™ç™»æ–°åŒº", "æ²™ç™»æ—§åŒº"] },
            { zone: "ä¸­3", areas: ["è’²ç§åŸ", "è’²ç§å¸‚", "è’²ç§éƒ½", "è’²ç§é•‡"] },
            { zone: "ä¸­4", areas: ["å¸ƒé«˜åŸ", "æ¢³é‚¦å†ä¹Ÿ"] },
            { zone: "ä¸­5", areas: ["æ­¦å‰æ—¥è½æ´", "èäºšå—"] },
            { zone: "åŠŸèƒ½çµ„", areas: ["åŠŸèƒ½çµ„", "è‹±æ–‡çµ„", "é†«ç™‚çµ„"] },
            { zone: "åŒ—1", areas: ["SVD", "ä¸‡æŒ ", "æ–¯é‡Œç™½æ²™ç½—"] },
            { zone: "åŒ—2", areas: ["å…«æ‰“çµ", "ç™½æ²™ç½—"] },
            { zone: "åŒ—B", areas: ["å¢æ±Ÿ", "å³‡éƒ½æ€¥", "æ–‡è‰¯æ¸¯", "æ—ºæ²™ç›ç ", "ç”²æ´å«æ˜Ÿå¸‚", "ç”²æ´å¸æ²™", "ç”²æ´é©¬é²é‡Œ"] },
            { zone: "åˆå¿ƒ", areas: ["åŠŸèƒ½çµ„", "è’²ç§å¸‚"] },
            { zone: "è¥¿åŒ—", areas: ["åŠ åŸ”å«æ˜Ÿå¸‚", "å®è¾¾é˜¿å—", "æ°¸å®‰é•‡", "é€‚è€•åº„å¤§æ¸¯"] },
            { zone: "è¥¿å—1", areas: ["åœ£æ·˜æ²™", "å¿«ä¹å›­"] },
            { zone: "è¥¿å—2", areas: ["æ­¦å‰ä¸å®œ", "è¬çµ¨"] }
        ];

        const CONFIG = {
            totalDots: 6000,
            targetCount: 6000,
            storageKey: 'tzuchi_final_prod_v1',
            imagePath: 'Shape.jpeg'
        };

        let state = {
            count: parseInt(localStorage.getItem(CONFIG.storageKey)) || 0,
            dots: [], availableIndices: [], lang: 'zh'
        };

        let ui = {};

        // --- å¯åŠ¨æµç¨‹ ---
        window.onload = function() {
            // ç»‘å®š UI å…ƒç´ 
            ui = {
                intro: document.getElementById('intro-layer'),
                lang: document.getElementById('lang-layer'),
                main: document.getElementById('main-content'),
                svg: document.getElementById('svg-stage'),
                count: document.getElementById('count-display'),
                remaining: document.getElementById('remaining-display'),
                modal: document.getElementById('modal'),
                modalBox: document.getElementById('modal-box')
            };

            initAreaDropdown();

            // æ£€æŸ¥ä½›åƒåŠ è½½ (å°è¯•è‡ªåŠ¨ï¼Œå¤±è´¥åˆ™æ˜¾ç¤ºæ‰‹åŠ¨)
            const img = document.getElementById('buddha-img');
            if (img.complete && img.naturalHeight !== 0) {
                startIntro();
            }
            // å¦åˆ™ onerror ä¼šè‡ªåŠ¨è§¦å‘æ˜¾ç¤ºæŒ‰é’®

            // æ£€æŸ¥è§†é¢‘åŠ è½½
            const v = document.getElementById('main-video');
            v.oncanplay = () => document.getElementById('video-upload').style.display = 'none';
            v.onerror = () => document.getElementById('video-upload').style.display = 'flex';

            // å¼€å§‹ç”Ÿæˆå›¾å½¢
            initShape();
        };

        // --- åˆå§‹åŒ–ä¸‹æ‹‰èœå• ---
        function initAreaDropdown() {
            const select = document.getElementById('area');
            while(select.options.length > 1) { select.remove(1); }
            
            AREA_DATA.forEach(group => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = group.zone;
                group.areas.forEach(area => {
                    const option = document.createElement('option');
                    option.value = `${group.zone}-${area}`;
                    option.textContent = area;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            });
        }

        // --- æµç¨‹æ§åˆ¶ ---
        window.startIntro = function() {
            setTimeout(() => {
                // å¼ºåˆ¶é‡ç»˜ï¼Œè§¦å‘3ç§’æ·¡å‡º
                if (ui.intro) { void ui.intro.offsetWidth; ui.intro.style.opacity = '0'; }
                if (ui.lang) { ui.lang.style.display = 'flex'; void ui.lang.offsetWidth; ui.lang.style.opacity = '1'; }
                setTimeout(() => { if (ui.intro) ui.intro.style.display = 'none'; }, 3100);
            }, 1000);
        }

        window.selectLang = function(lang) {
            state.lang = lang;
            updateText();
            if (ui.lang) ui.lang.style.opacity = '0';
            if (ui.main) { ui.main.classList.remove('hidden'); void ui.main.offsetWidth; ui.main.style.opacity = '1'; }
            
            // æ‰‹æœºç«¯è§£é”æ»šåŠ¨
            document.body.classList.remove('no-scroll');

            setTimeout(() => {
                if (ui.lang) ui.lang.style.display = 'none';
                // å°è¯•æ’­æ”¾è§†é¢‘
                const v = document.getElementById('main-video');
                if(v && v.paused) v.play().catch(() => {}); 
            }, 1000);
        }

        function updateText() {
            document.querySelectorAll('.lang-text').forEach(el => {
                el.innerHTML = el.getAttribute(`data-${state.lang}`);
            });
            // ç®€å•å¤„ç† placeholder
            const nameInput = document.getElementById('name');
            const phoneInput = document.getElementById('phone');
            if (state.lang === 'en') {
                nameInput.placeholder = "Your Name";
                phoneInput.placeholder = "Phone Number";
            } else {
                nameInput.placeholder = "æ‚¨çš„å§“å";
                phoneInput.placeholder = "æ‰‹æ©Ÿè™Ÿç¢¼";
            }
        }

        // --- å›¾å½¢å¤„ç† ---
        function initShape() {
            updateStats();
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = () => processShapeImage(img);
            img.onerror = () => showUploadUi('shape-upload');
            img.src = CONFIG.imagePath;
        }

        window.processShapeImage = function(imgSource) {
            document.getElementById('shape-upload').style.display = 'none';
            document.getElementById('shape-loading').style.display = 'flex';
            const img = (imgSource instanceof Image) ? imgSource : new Image();
            if (!(imgSource instanceof Image)) img.src = imgSource;
            
            img.onload = () => {
                const canvas = document.getElementById('analysis-canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 1000; canvas.height = 400;
                ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0, 0, 1000, 400);
                
                const scale = Math.min(1000/img.width, 400/img.height);
                const w = img.width * scale, h = img.height * scale;
                ctx.drawImage(img, (1000-w)/2, (400-h)/2, w, h);
                
                const data = ctx.getImageData(0,0,1000,400).data;
                const pixels = [];
                // ä¼˜åŒ–é‡‡æ ·å¯†åº¦
                for(let y=0; y<400; y+=3) { 
                    for(let x=0; x<1000; x+=3) {
                        const i = (y*1000 + x) * 4;
                        if (data[i] < 200 && data[i+1] < 200 && data[i+2] < 200 && data[i+3] > 128) {
                            pixels.push({x, y});
                        }
                    }
                }
                generateDots(pixels);
            };
        }

        function generateDots(pixels) {
            const fragment = document.createDocumentFragment();
            state.dots = [];
            for(let i=0; i<CONFIG.totalDots; i++) {
                let p = pixels.length ? pixels[Math.floor(Math.random()*pixels.length)] : {x:500, y:200};
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", (p.x + (Math.random()-0.5)*4).toFixed(1));
                circle.setAttribute("cy", (p.y + (Math.random()-0.5)*4).toFixed(1));
                circle.setAttribute("r", (1 + Math.random()).toFixed(1));
                circle.setAttribute("class", "dot");
                fragment.appendChild(circle);
                state.dots.push({el: circle});
            }
            state.availableIndices = Array.from({length: CONFIG.totalDots}, (_, k) => k).sort(() => Math.random() - 0.5);
            
            ui.svg.innerHTML = '';
            ui.svg.appendChild(fragment);
            document.getElementById('shape-loading').style.display = 'none';
            ui.svg.style.opacity = '1';
            restoreLitDots();
        }

        function updateStats() {
            if (!ui.count) return;
            ui.count.innerText = state.count;
            ui.remaining.innerText = Math.max(0, CONFIG.targetCount - state.count);
        }

        function restoreLitDots() {
            for(let i=0; i<state.count && i<state.availableIndices.length; i++) {
                if (state.dots[state.availableIndices[i]]) state.dots[state.availableIndices[i]].el.classList.add('active');
            }
        }

        // --- äº¤äº’é€»è¾‘ ---
        document.getElementById('prayer-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const origText = btn.querySelector('span').innerText;
            btn.disabled = true;
            btn.querySelector('span').innerText = state.lang === 'zh' ? 'ç¥ˆé¡˜å‚³é€ä¸­...' : 'Sending...';
            btn.classList.add('opacity-50');

            setTimeout(() => {
                if(state.count < CONFIG.totalDots) {
                    const idx = state.availableIndices[state.count];
                    const target = state.dots[idx];
                    
                    // ç‚¹ç¯ç‰¹æ•ˆ
                    if (target) target.el.classList.add('active');
                    if (ui.svg) ui.svg.classList.add('flash-mode');
                    
                    setTimeout(() => {
                        if (ui.svg) ui.svg.classList.remove('flash-mode');
                        setTimeout(() => {
                            ui.modal.classList.remove('hidden');
                            void ui.modal.offsetWidth; ui.modal.style.opacity = '1';
                            ui.modalBox.style.transform = 'scale(1)';
                        }, 1500);
                    }, 2500);
                    
                    state.count++;
                    localStorage.setItem(CONFIG.storageKey, state.count);
                    updateStats();
                } else { alert("åŠŸå¾·åœ“æ»¿"); }

                setTimeout(() => {
                    btn.disabled = false;
                    btn.querySelector('span').innerText = origText;
                    btn.classList.remove('opacity-50');
                    e.target.reset();
                }, 3000);
            }, 500);
        });

        window.closeModal = function() {
            ui.modal.style.opacity = '0';
            ui.modalBox.style.transform = 'scale(0.9)';
            setTimeout(() => ui.modal.classList.add('hidden'), 500);
        }
    </script>
</body>
</html>
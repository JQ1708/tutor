<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ…ˆæµ60å‘¨å¹´ - æµ´ä½›èŠ‚ä¸‡äººç‚¹ç¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Serif TC', serif;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            color: #f8fafc;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .tzuchi-gold { color: #fbbf24; }
        
        /* === æ ¸å¿ƒç‚¹é˜µæ ·å¼ === */
        .dot {
            fill: #334155; /* é»˜è®¤ï¼šæš—è‰² */
            opacity: 0.3;  
            r: 1.2; /* é»˜è®¤åŠå¾„ */
            
            /* Slow Off: å½“å…¨äº®æ¨¡å¼ç»“æŸæ—¶ï¼Œæ…¢æ…¢å˜å›æš—è‰²çš„è¿‡æ¸¡æ—¶é—´ */
            transition: fill 2.5s ease-out, opacity 2.5s ease-out, r 2.5s ease-out, filter 2.5s ease-out;
            
            transform-box: fill-box;
            transform-origin: center;
        }

        /* çŠ¶æ€1ï¼šè¢«ç‚¹äº®çš„é‚£é¢—æ˜Ÿ (Target) */
        .dot.active {
            fill: #fbbf24; /* é‡‘è‰² */
            opacity: 1;
            r: 3.5; /* æ”¾å¤§ */
            filter: drop-shadow(0 0 5px #fbbf24);
        }

        /* çŠ¶æ€2ï¼šå…¨å›¾äº®èµ·æ¨¡å¼ (Flash Mode - Instant On) */
        .flash-mode .dot {
            fill: #ffffff !important;   /* çº¯ç™½ */
            opacity: 1 !important;      /* ä¸é€æ˜ */
            r: 3.0 !important;          /* å…¨ä½“æ”¾å¤§ */
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.8)) !important;
            
            /* å…³é”®ï¼šç¬é—´ç‚¹äº®ï¼Œä¸éœ€è¦è¿‡æ¸¡ */
            transition: none !important;
        }

        /* çŠ¶æ€3ï¼šTarget åœ¨å…¨äº®æ¨¡å¼ä¸‹çš„ç‰¹æ®Šæ ·å¼ */
        .flash-mode .dot.active {
            fill: #fef08a !important; /* å¸¦ä¸€ç‚¹é‡‘çš„ç™½ */
            r: 4.5 !important;        /* æ›´å¤§ */
            z-index: 10;
        }

        /* å±å¹•é—ªå…‰å±‚ */
        #screen-flash {
            position: fixed;
            inset: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 60;
            transition: opacity 2.0s ease-out;
        }
        #screen-flash.active {
            opacity: 0.3; /* ç¬é—´é—ªä¸€ä¸‹ */
            transition: none;
        }

        /* é£è¡Œå…‰çƒ */
        #flying-light {
            position: fixed;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #fff 40%, #fbbf24 100%);
            border-radius: 50%;
            box-shadow: 0 0 20px #fff, 0 0 40px #fbbf24;
            pointer-events: none;
            z-index: 50;
            display: none;
            transition: transform 1.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s;
        }

        /* è²èŠ±ç¯æµ®åŠ¨ */
        .lotus-lamp {
            filter: drop-shadow(0 0 20px #fbbf24);
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        #analysis-canvas { display: none; }
        .input-focus-effect:focus {
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);
            border-color: #fbbf24;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-between min-h-screen relative">

    <div id="screen-flash"></div>

    <!-- é¡¶éƒ¨æ•°æ®æ  -->
    <div class="fixed top-0 left-0 w-full z-20 flex justify-between items-start p-4 md:p-8 pointer-events-none">
        <div class="text-left bg-black/40 backdrop-blur-md p-4 rounded-lg border-l-4 border-yellow-500 shadow-lg">
            <div class="text-gray-400 text-xs md:text-sm uppercase tracking-wider">å·²ç‚¹ç¯è©è¨</div>
            <div class="text-3xl md:text-5xl font-bold text-white tracking-widest mt-1" id="count-display">0</div>
        </div>
        <div class="text-right bg-black/40 backdrop-blur-md p-4 rounded-lg border-r-4 border-gray-500 shadow-lg">
            <div class="text-gray-400 text-xs md:text-sm uppercase tracking-wider">è·ç¦»åœ†æ»¡ç›®æ ‡</div>
            <div class="text-3xl md:text-5xl font-bold text-gray-300 tracking-widest mt-1" id="remaining-display">8000</div>
        </div>
    </div>

    <!-- æ ¸å¿ƒåŒºåŸŸï¼šSVG å›¾è…¾ -->
    <div class="flex-grow w-full flex flex-col items-center justify-center relative mt-20 mb-32 md:my-0 px-4">
        
        <!-- è‡ªåŠ¨åŠ è½½çŠ¶æ€æç¤º -->
        <div id="loading-spinner" class="absolute z-30 flex flex-col items-center justify-center text-yellow-500 transition-opacity duration-300">
            <svg class="animate-spin h-8 w-8 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="font-bold tracking-widest text-lg">å›¾è…¾ç”Ÿæˆä¸­...</span>
        </div>

        <!-- æ‰‹åŠ¨åŠ è½½å›é€€ UI (é»˜è®¤éšè—ï¼Œåªæœ‰å‡ºé”™æ—¶æ‰æ˜¾ç¤º) -->
        <div id="fallback-ui" class="hidden absolute z-30 flex flex-col items-center bg-slate-900/90 p-8 rounded-xl border border-yellow-500/50 shadow-2xl backdrop-blur text-center max-w-md">
            <div class="text-yellow-500 text-4xl mb-4">âš ï¸</div>
            <h3 class="text-xl text-white font-bold mb-2">æœ¬åœ°é¢„è§ˆæ¨¡å¼</h3>
            <p class="text-gray-400 text-sm mb-6">
                æ— æ³•è‡ªåŠ¨è¯»å– <b>Shape.jpeg</b> (æµè§ˆå™¨å®‰å…¨é™åˆ¶)ã€‚<br>
                è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰‹åŠ¨é€‰æ‹©è¯¥å›¾ç‰‡ä»¥ç»§ç»­æµ‹è¯•ã€‚<br>
                <span class="text-yellow-600 text-xs block mt-2">(ä¸Šä¼ è‡³ GitHub åå°†è‡ªåŠ¨åŠ è½½ï¼Œä¸å†æ˜¾ç¤ºæ­¤æŒ‰é’®)</span>
            </p>
            <label class="cursor-pointer bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-3 px-6 rounded-full transition transform active:scale-95">
                é€‰æ‹© Shape.jpeg
                <input type="file" id="file-input" accept="image/*" class="hidden">
            </label>
        </div>

        <svg id="main-stage" viewBox="0 0 1000 400" preserveAspectRatio="xMidYMid meet" class="w-full max-w-7xl h-auto z-10 opacity-0 transition-opacity duration-1000">
            <!-- æ‰€æœ‰çš„åœ†ç‚¹å°†é€šè¿‡ JS åŠ¨æ€æ’å…¥è¿™é‡Œ -->
        </svg>
    </div>

    <!-- åº•éƒ¨ï¼šæŠ¥åå¤„ -->
    <div class="w-full bg-slate-900/90 backdrop-blur-xl border-t border-white/10 p-6 z-30 fixed bottom-0 md:relative md:bg-transparent md:border-none md:bottom-auto md:p-10 md:w-auto">
        <div class="max-w-md mx-auto text-center" id="form-section">
            <h2 class="text-xl md:text-2xl mb-6 text-white font-light tracking-wide">
                <span class="text-yellow-500">ç‚¹äº®å¿ƒç¯</span> &middot; å…±èšå–„å¿µ
            </h2>
            
            <form id="prayer-form" class="space-y-4">
                <input type="text" id="name" required placeholder="è¯·è¾“å…¥æ‚¨çš„å¤§å" 
                       class="w-full bg-white/10 border border-white/20 text-white p-4 rounded-lg text-center placeholder-gray-400 input-focus-effect outline-none transition">
                
                <input type="tel" id="phone" required placeholder="æ‰‹æœºå·ç " 
                       class="w-full bg-white/10 border border-white/20 text-white p-4 rounded-lg text-center placeholder-gray-400 input-focus-effect outline-none transition">
                
                <button type="submit" 
                        class="w-full bg-gradient-to-r from-yellow-700 to-yellow-500 hover:from-yellow-600 hover:to-yellow-400 text-white hover:text-black font-bold py-4 px-6 rounded-lg shadow-[0_0_20px_rgba(234,179,8,0.3)] transition-all transform active:scale-95 uppercase tracking-widest">
                    å‘ˆäº¤ç¥ˆæ„¿
                </button>
            </form>
        </div>
    </div>

    <!-- åŠ¨ç”»å±‚ -->
    <div id="animation-overlay" class="fixed inset-0 bg-black/85 z-40 flex items-center justify-center hidden opacity-0 transition-opacity duration-500">
        <div id="lamp-container" class="text-center transform scale-0 transition-transform duration-700">
            <svg width="180" height="140" viewBox="0 0 200 150" class="lotus-lamp mx-auto">
                <defs>
                    <radialGradient id="lampGlow" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                        <stop offset="0%" style="stop-color:rgb(255, 255, 200);stop-opacity:1" />
                        <stop offset="100%" style="stop-color:rgb(250, 204, 21);stop-opacity:0" />
                    </radialGradient>
                </defs>
                <ellipse cx="100" cy="100" rx="60" ry="20" fill="url(#lampGlow)" opacity="0.6" />
                <path d="M100 130 C 60 130, 40 100, 20 80 C 40 90, 80 110, 100 110 C 120 110, 160 90, 180 80 C 160 100, 140 130, 100 130 Z" fill="#ca8a04" />
                <path d="M100 115 C 90 85, 70 65, 50 55 C 70 75, 90 95, 100 105 C 110 95, 130 75, 150 55 C 130 65, 110 85, 100 115 Z" fill="#eab308" />
                <path d="M100 105 C 95 75, 90 45, 100 25 C 110 45, 105 75, 100 105 Z" fill="#fef08a" class="animate-pulse" style="filter: drop-shadow(0 0 5px #fff);" />
            </svg>
            <div class="text-yellow-400 mt-6 text-xl tracking-[0.2em] font-light border-t border-b border-yellow-500/30 py-2 inline-block">å¿ƒç¯å·²ç‚¹äº®</div>
        </div>
    </div>

    <!-- æˆåŠŸå¼¹çª— -->
    <div id="success-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden pointer-events-none">
        <div class="bg-slate-900/95 p-8 rounded-2xl max-w-sm text-center border border-yellow-500/50 shadow-2xl transform scale-90 opacity-0 transition-all duration-500 pointer-events-auto" id="modal-content">
            <div class="text-5xl mb-6 animate-bounce">ğŸ™</div>
            <h3 class="text-xl text-yellow-400 font-bold mb-3 leading-relaxed">
                æ„Ÿæ©æŠ¥åï¼Œ<br>æˆ‘ä»¬ä¼šå°½å¿«ä¸ä½ è”ç³»
            </h3>
            
            <button onclick="closeModal()" class="w-full mt-6 border border-yellow-600 text-yellow-500 hover:bg-yellow-600 hover:text-black px-6 py-3 rounded-lg transition font-bold uppercase tracking-wider">
                å…³é—­
            </button>
        </div>
    </div>

    <div id="flying-light"></div>
    <canvas id="analysis-canvas"></canvas>

    <script>
        const CONFIG = {
            totalDots: 8000,
            targetCount: 8000,
            storageKey: 'tzuchi_event_data_v2',
            imagePath: 'Shape.jpeg' 
        };

        let state = {
            count: parseInt(localStorage.getItem(CONFIG.storageKey)) || 0,
            dots: [], 
            availableIndices: [] 
        };

        const ui = {
            stage: document.getElementById('main-stage'),
            count: document.getElementById('count-display'),
            remaining: document.getElementById('remaining-display'),
            form: document.getElementById('prayer-form'),
            overlay: document.getElementById('animation-overlay'),
            lamp: document.getElementById('lamp-container'),
            flyer: document.getElementById('flying-light'),
            modal: document.getElementById('success-modal'),
            modalContent: document.getElementById('modal-content'),
            spinner: document.getElementById('loading-spinner'),
            fallback: document.getElementById('fallback-ui'),
            fileInput: document.getElementById('file-input'),
            screenFlash: document.getElementById('screen-flash')
        };

        function init() {
            updateStats();
            
            // è‡ªåŠ¨åŠ è½½å›¾ç‰‡
            const img = new Image();
            img.crossOrigin = "Anonymous"; 
            
            img.onload = () => processImage(img);
            
            img.onerror = () => {
                // å¦‚æœè‡ªåŠ¨åŠ è½½å¤±è´¥ï¼ˆé€šå¸¸æ˜¯å› ä¸ºæœ¬åœ°ç¯å¢ƒ/é¢„è§ˆç¯å¢ƒçš„å®‰å…¨é™åˆ¶ï¼‰
                // åˆ™éšè— Loadingï¼Œæ˜¾ç¤ºæ‰‹åŠ¨é€‰æ‹©æŒ‰é’®
                // æ³¨æ„ï¼šåœ¨ GitHub Pages ç­‰æœåŠ¡å™¨ç¯å¢ƒä¸‹ï¼Œåªè¦æ–‡ä»¶åæ­£ç¡®ï¼Œè¿™é‡Œä¸ä¼šè§¦å‘
                console.log("è‡ªåŠ¨åŠ è½½å¤±è´¥ (CORS/Path limit)ï¼Œåˆ‡æ¢è‡³æ‰‹åŠ¨æ¨¡å¼ã€‚");
                ui.spinner.classList.add('opacity-0');
                setTimeout(() => ui.spinner.classList.add('hidden'), 300);
                
                ui.fallback.classList.remove('hidden');
            };
            
            // å¼€å§‹åŠ è½½
            img.src = CONFIG.imagePath;
        }

        // ç›‘å¬æ‰‹åŠ¨é€‰æ‹©æ–‡ä»¶ (ä»…ç”¨äºæœ¬åœ°/é¢„è§ˆè°ƒè¯•)
        ui.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                ui.fallback.classList.add('hidden');
                ui.spinner.classList.remove('hidden', 'opacity-0');
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => processImage(img);
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        function processImage(img) {
            // ç»™ä¸€ç‚¹å»¶è¿Ÿè®©UIæ˜¾å¾—æ›´è‡ªç„¶
            setTimeout(() => {
                const canvas = document.getElementById('analysis-canvas');
                const ctx = canvas.getContext('2d');
                
                const w = 1000;
                const h = 400;
                canvas.width = w;
                canvas.height = h;

                // ä¿æŒæ¯”ä¾‹ç»˜åˆ¶å›¾ç‰‡
                const scale = Math.min(w / img.width, h / img.height);
                const drawW = img.width * scale;
                const drawH = img.height * scale;
                const offsetX = (w - drawW) / 2;
                const offsetY = (h - drawH) / 2;

                // ç»˜åˆ¶èƒŒæ™¯å’Œå›¾ç‰‡
                ctx.fillStyle = "#FFFFFF"; 
                ctx.fillRect(0, 0, w, h);
                ctx.drawImage(img, offsetX, offsetY, drawW, drawH);

                const imageData = ctx.getImageData(0, 0, w, h);
                const data = imageData.data;
                const darkPixels = [];

                // é‡‡æ ·åƒç´ 
                for (let y = 0; y < h; y += 2) {
                    for (let x = 0; x < w; x += 2) {
                        const i = (y * w + x) * 4;
                        const r = data[i];
                        const g = data[i+1];
                        const b = data[i+2];
                        const alpha = data[i+3];

                        // è¯†åˆ«æ·±è‰²åŒºåŸŸ
                        if (alpha > 128 && r < 180 && g < 180 && b < 180) {
                            darkPixels.push({x, y});
                        }
                    }
                }

                generateDotsFromPixels(darkPixels);
            }, 500);
        }

        function generateDotsFromPixels(pixelPool) {
            const fragment = document.createDocumentFragment();
            state.dots = [];
            state.availableIndices = [];
            
            for (let i = 0; i < CONFIG.totalDots; i++) {
                let p;
                if (pixelPool.length > 0) {
                    const randIndex = Math.floor(Math.random() * pixelPool.length);
                    p = pixelPool[randIndex];
                    // å¾®å°æŠ–åŠ¨ï¼Œå¢åŠ è‡ªç„¶æ„Ÿ
                    p = {
                        x: p.x + (Math.random() - 0.5) * 3, 
                        y: p.y + (Math.random() - 0.5) * 3
                    };
                } else {
                    p = {x: 500, y: 200};
                }

                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", p.x.toFixed(1));
                circle.setAttribute("cy", p.y.toFixed(1));
                
                // éšæœºå¤§å° 1.0 - 1.8
                const r = 1.0 + Math.random() * 0.8;
                circle.setAttribute("r", r);
                circle.setAttribute("class", "dot");
                
                fragment.appendChild(circle);

                state.dots.push({
                    el: circle,
                    x: p.x,
                    y: p.y
                });
            }

            // éšæœºåŒ–ç‚¹ç¯é¡ºåº
            const indices = Array.from({length: CONFIG.totalDots}, (_, k) => k);
            shuffleArray(indices);
            state.availableIndices = indices;

            // æ¸²æŸ“åˆ°èˆå°
            ui.stage.innerHTML = '';
            ui.stage.appendChild(fragment);
            
            // éšè—Loadingï¼Œæ˜¾ç¤ºèˆå°
            ui.spinner.classList.add('hidden');
            ui.stage.classList.remove('opacity-0');

            restoreProgress();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function updateStats() {
            ui.count.innerText = state.count;
            const remaining = CONFIG.targetCount - state.count;
            ui.remaining.innerText = Math.max(0, remaining);
        }

        function restoreProgress() {
            for (let i = 0; i < state.count && i < state.availableIndices.length; i++) {
                const dotIndex = state.availableIndices[i];
                const dot = state.dots[dotIndex];
                if (dot) {
                    dot.el.classList.add('active');
                }
            }
        }

        ui.form.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            if (!name || !phone) return;

            const btn = ui.form.querySelector('button');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "ç¥ˆæ„¿ä¼ é€ä¸­...";
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            startRitual(() => {
                state.count++;
                localStorage.setItem(CONFIG.storageKey, state.count);
                updateStats();

                btn.disabled = false;
                btn.innerText = originalText;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                ui.form.reset();
            });
        });

        function startRitual(callback) {
            ui.overlay.classList.remove('hidden');
            void ui.overlay.offsetWidth; 
            ui.overlay.classList.remove('opacity-0');
            
            setTimeout(() => {
                ui.lamp.classList.remove('scale-0');
                ui.lamp.classList.add('scale-100');
            }, 100);

            // åœç•™ 1.5s åï¼ŒåŒ–å…‰é£å…¥
            setTimeout(() => {
                const nextIndexPtr = state.count; 
                
                if (nextIndexPtr >= state.availableIndices.length) {
                    alert("åŠŸå¾·åœ†æ»¡ï¼");
                    ui.overlay.classList.add('hidden');
                    return;
                }

                const targetDotIndex = state.availableIndices[nextIndexPtr];
                const targetDot = state.dots[targetDotIndex];

                const lampRect = ui.lamp.getBoundingClientRect();
                const startX = lampRect.left + lampRect.width / 2;
                const startY = lampRect.top + lampRect.height / 2;

                const pt = ui.stage.createSVGPoint();
                pt.x = targetDot.x;
                pt.y = targetDot.y;
                const globalPt = pt.matrixTransform(ui.stage.getScreenCTM());

                ui.flyer.style.display = 'block';
                ui.flyer.style.transform = `translate(${startX}px, ${startY}px) scale(2)`;
                ui.flyer.style.opacity = '1';

                ui.lamp.classList.remove('scale-100');
                ui.lamp.classList.add('scale-0');

                requestAnimationFrame(() => {
                    ui.flyer.style.transform = `translate(${globalPt.x}px, ${globalPt.y}px) scale(0.5)`;
                });

                // 1.5s ååˆ°è¾¾
                setTimeout(() => {
                    ui.flyer.style.opacity = '0';
                    setTimeout(() => ui.flyer.style.display = 'none', 500);

                    targetDot.el.classList.add('active');

                    // === è§†è§‰é«˜æ½®ï¼šFlash Mode + Screen Flash ===
                    ui.stage.classList.add('flash-mode');
                    ui.screenFlash.classList.add('active');

                    // ç»´æŒ 1.2 ç§’çš„å…¨äº®çŠ¶æ€
                    setTimeout(() => {
                        // ç§»é™¤é«˜äº® -> è§¦å‘ Slow Off (2.5s)
                        ui.stage.classList.remove('flash-mode');
                        ui.screenFlash.classList.remove('active');

                        // ç­‰å¾…æ”¶ç¼©åŠ¨ç”»è¿›è¡Œä¸€éƒ¨åˆ† (2s) åå†å¼¹å‡ºè§†çª—
                        setTimeout(() => {
                            ui.overlay.classList.add('opacity-0');
                            setTimeout(() => {
                                ui.overlay.classList.add('hidden');
                                ui.modal.classList.remove('hidden');
                                setTimeout(() => {
                                    ui.modalContent.classList.remove('scale-90', 'opacity-0');
                                    ui.modalContent.classList.add('scale-100', 'opacity-100');
                                }, 50);

                                callback(); 
                            }, 500);
                        }, 2000); 

                    }, 1200); // ç»´æŒå…¨äº®æ—¶é—´

                }, 1500); // é£è¡Œæ—¶é—´

            }, 2000); // åœç•™æ—¶é—´
        }

        function closeModal() {
            ui.modalContent.classList.remove('scale-100', 'opacity-100');
            ui.modalContent.classList.add('scale-90', 'opacity-0');
            setTimeout(() => {
                ui.modal.classList.add('hidden');
            }, 300);
        }

        window.onload = init;

    </script>
</body>
</html>